rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read/write their own user profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin/subadmin to read any user profile
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
      
      // Allow admin to write/update any user profile (for blocking/unblocking, role changes)
      allow write, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin'
      );
    }

    // Allow authenticated users to access their own transactions and categories
    match /transactions/{userId}/user_transactions/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin/subadmin to read all transactions
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'
      );
    }

    match /categories/{userId}/user_categories/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin/subadmin to read all categories
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'
      );
    }

    // Allow authenticated users to access their own bank accounts
    match /users/{userId}/bankAccounts/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin/subadmin to read all bank accounts
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
    }

    // Allow authenticated users to access their own bank account transactions
    match /users/{userId}/bankAccounts/{accountId}/transactions/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin/subadmin to read all bank account transactions
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
    }

    // User activity: only allow user to write their own activity
    match /user_activity/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin to read all user activity
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
    }

    // Allow admin/subadmin to read and write admin replies
    match /admin_replies/{docId} {
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
      allow write, create, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'
      );
    }

    // Allow admin/subadmin to read and manage support messages
    match /support_messages/{docId} {
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'
      );
      allow write, create: if request.auth != null; // Allow any authenticated user to create support messages
      allow update, delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'
      );
    }

    // Allow admin/subadmin to read user messages
    match /user_messages/{docId} {
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
    }

    // Allow authenticated users to access their own messages
    match /messages/{userId}/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin/subadmin to read all messages
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
    }

    // Allow any authenticated user to access messages collection (temporary fix)
    match /messages/{document=**} {
      allow read, write: if request.auth != null;
    }

    // Allow authenticated users to access their own budget data
    match /budgets/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admin/subadmin to read all budget data
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
    }

    // Temporary: Allow any authenticated user to read/write budgets (for testing)
    match /budgets/{document=**} {
      allow read, write: if request.auth != null;
    }

    // Allow any authenticated user to access all collections (temporary fix for all permission issues)
    match /transactions/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    match /categories/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    match /bank_accounts/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow authenticated users to access global bank accounts collection
    match /bank_accounts/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Allow admin/subadmin to read all bank accounts
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
      
      // Allow users to create bank accounts
      allow create: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Allow authenticated users to access global transactions collection
    match /transactions/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Allow admin/subadmin to read all transactions
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
    }

    // Allow authenticated users to access global categories collection
    match /categories/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Allow admin/subadmin to read all categories
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'subadmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user/subadmin'||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user'
      );
    }

    // By default, deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}